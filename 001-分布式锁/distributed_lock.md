[toc]

### ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”
> åœ¨è°ˆåˆ†å¸ƒå¼é”ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»è¦çŸ¥é“ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ

ä¸åˆ†å¸ƒå¼é”å¯¹åº”çš„æ˜¯**å•æœºé”**ï¼Œæˆ‘ä»¬åœ¨å†™å¤šçº¿ç¨‹ç¨‹åºçš„æ—¶å€™ï¼Œä¸ºäº†é¿å…åŒæ—¶æ“ä½œåŒä¸€ä¸ªå…±äº«å˜é‡äº§ç”Ÿæ•°æ®é—®é¢˜ï¼Œé€šå¸¸ä¼šä½¿ç”¨ä¸€æŠŠğŸ”’æ¥**è¿›è¡Œäº’æ–¥**ï¼Œä»¥ä¿è¯å…±äº«å˜é‡çš„æ­£ç¡®æ€§ï¼Œå…¶ä½¿ç”¨èŒƒå›´æ˜¯åœ¨**åŒä¸€ä¸ªè¿›ç¨‹**ä¸­ã€‚

å¦‚æœæ¢åšæ˜¯å¤šä¸ªè¿›ç¨‹ï¼Œéœ€è¦åŒæ—¶æ“ä½œä¸€ä¸ªå…±äº«èµ„æºï¼Œå¦‚ä½•äº’æ–¥å‘¢ï¼Ÿ

ä¾‹å¦‚ï¼Œç°åœ¨çš„ä¸šåŠ¡åº”ç”¨é€šå¸¸éƒ½æ˜¯å¾®æœåŠ¡æ¶æ„ï¼Œè¿™ä¹Ÿæ„å‘³ç€ä¸€ä¸ªåº”ç”¨ä¼šéƒ¨ç½²å¤šä¸ªè¿›ç¨‹(è§ä¸‹å›¾1æ‰€ç¤º)ï¼Œé‚£è¿™å¤šä¸ªè¿›ç¨‹å¦‚æœéœ€è¦ä¿®æ”¹MySQLä¸­çš„åŒä¸€è¡Œè®°å½•æ—¶ï¼Œä¸ºäº†é¿å…æ“ä½œä¹±åºå¯¼è‡´æ•°æ®é”™è¯¯ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦å¼•å…¥**åˆ†å¸ƒå¼é”ğŸ”’**æ¥è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚
![å¾®æœåŠ¡æ¶æ„ç¤ºä¾‹](./picture/what-is-it-001-001.svg)

è¦æƒ³å®ç°åˆ†å¸ƒå¼é”ï¼Œå¿…é¡»å€ŸåŠ©ä¸€ä¸ªå¤–éƒ¨ç³»ç»Ÿï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½å»è¿™ä¸ªç³»ç»Ÿä¸Šå»**ç”³è¯·åŠ é”ğŸ”’**ã€‚

è€Œè¿™ä¸ªå¤–éƒ¨ç³»ç»Ÿï¼Œå¿…é¡»å®ç°**äº’æ–¥**çš„èƒ½åŠ›ï¼Œå³ä¸¤ä¸ªè¯·æ±‚è¿›æ¥ï¼Œåªä¼šç»™ä¸€ä¸ªè¿›ç¨‹è¿”å›æˆåŠŸï¼Œå¦ä¸€ä¸ªè¿”å›å¤±è´¥(æˆ–è€…ç­‰å¾…)ã€‚

è¿™ä¸ªå¤–éƒ¨ç³»ç»Ÿï¼Œå¯ä»¥æ˜¯ MySQL, ä¹Ÿå¯ä»¥æ˜¯ Redis æˆ– Zookeeperã€‚ä½†ä¸ºäº†è¿½æ±‚æ›´é«˜çš„æ€§èƒ½ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½ä¼šé€‰æ‹©æ˜¯ç”¨ Redis æˆ– Zookeeper æ¥åšã€‚

ä¸‹é¢æˆ‘ä»¬å°±ä»¥ Redis ä¸ºä¸»çº¿ï¼Œç”±æµ…å…¥æ·±ï¼Œæ¥ä¸€èµ·æ¢è®¨åˆ†å¸ƒå¼é”çš„å„ç§**å®‰å…¨é—®é¢˜**ï¼Œå½»åº•ç†è§£åˆ†å¸ƒå¼é”ğŸ”’ã€‚

### Rediså¦‚ä½•å®ç°åˆ†å¸ƒå¼é”
> è®©æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„å¼€å§‹è¯´èµ·...

æƒ³è¦å®ç°åˆ†å¸ƒå¼é”ğŸ”’ï¼Œå¿…é¡»è¦æ±‚ Redis æœ‰**äº’æ–¥**çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `SETNX` å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤è¡¨ç¤º `SET if Not eXist`, å³å¦‚æœ Key ä¸å­˜åœ¨ï¼Œæ‰ä¼šè®¾ç½®å®ƒçš„å€¼ï¼Œå¦åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚

ä¸¤ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹å¯ä»¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œè¾¾åˆ°äº’æ–¥ï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ğŸ”’ã€‚

å®¢æˆ·ç«¯1ç”³è¯·åŠ é”ï¼ŒåŠ é”æˆåŠŸ:
```
127.0.0.1:6379> SETNX lock 1
(integer) 1  // å®¢æˆ·ç«¯1ï¼ŒåŠ é”æˆåŠŸ
```

å®¢æˆ·ç«¯2ç”³è¯·åŠ é”ï¼ŒåŠ é”æˆåŠŸ:
```
127.0.0.1:6379> SETNX lock 1
(integer) 0  // å®¢æˆ·ç«¯2ï¼ŒåŠ é”å¤±è´¥
```
å› æ­¤ï¼ŒåŠ é”æˆåŠŸçš„å®¢æˆ·ç«¯ï¼Œå°±å¯ä»¥å»æ“ä½œ**å…±äº«èµ„æº**ï¼Œä¾‹å¦‚ï¼Œä¿®æ”¹MySQLçš„æŸä¸€è¡Œæ•°æ®ï¼Œæˆ–è€…è°ƒç”¨ä¸€ä¸ªAPIè¯·æ±‚ã€‚

æ“ä½œå®Œæˆåï¼Œè¿˜éœ€è¦åŠæ—¶é‡Šæ”¾é”ğŸ”’ï¼Œç»™åæ¥è€…è®©å‡ºæ“ä½œå…±äº«èµ„æºçš„æœºä¼šã€‚å¦‚ä½•é‡Šæ”¾é”ğŸ”’å‘¢ï¼Ÿ

ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨ `DEL` è¿™ä¸ªå‘½ä»¤åˆ é™¤è¿™ä¸ª Key å³å¯:
```
127.0.0.1:6379> DEL lock
(integer) 1
```
è¿™ä¸ªé€»è¾‘éå¸¸ç®€å•ï¼Œæ•´ä½“æµç¨‹å°±æ˜¯è¿™æ ·:
![æµç¨‹å›¾](./picture/what-is-it-001-002.svg)

ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼å­˜åœ¨ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå½“å®¢æˆ·ç«¯1æ‹¿åˆ°é”åï¼Œå¦‚æœå‘ç”Ÿä¸‹é¢çš„åœºæ™¯ï¼Œå°±ä¼šé€ æˆ**æ­»é”**:
1. ç¨‹åºå¤„ç†ä¸šåŠ¡é€»è¾‘å¼‚å¸¸ï¼Œæ²¡åŠæ—¶é‡Šæ”¾é”
2. è¿›ç¨‹æŒ‚äº†ï¼Œæ²¡æœºä¼šé‡Šæ”¾é”

è¿™æ—¶ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å°±ä¼šä¸€ç›´å ç”¨è¿™ä¸ªé”ğŸ”’ï¼Œè€Œå…¶å®ƒå®¢æˆ·ç«¯å°±**æ°¸è¿œ**æ‹¿ä¸åˆ°è¿™æŠŠé”äº†ã€‚

é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

#### å¦‚ä½•é¿å…æ­»é”ï¼Ÿ
æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„æ–¹æ¡ˆæ˜¯ï¼Œåœ¨ç”³è¯·é”ğŸ”’çš„æ—¶å€™ï¼Œç»™è¿™æŠŠé”è®¾ç½®ä¸€ä¸ª**ç§ŸæœŸ**ã€‚

åœ¨ Redis ä¸­å®ç°æ—¶ï¼Œå°±æ˜¯ç»™è¿™ä¸ª Key åŠ ä¸€ä¸ª**è¿‡æœŸæ—¶é—´**ã€‚è¿™é‡Œæˆ‘ä»¬å‡è®¾ï¼Œæ“ä½œå…±äº«èµ„æºçš„æ—¶é—´ä¸ä¼šè¶…è¿‡ 10sï¼Œé‚£ä¹ˆåœ¨åŠ é”ğŸ”’æ—¶ï¼Œç»™è¿™ä¸ªkeyè®¾ç½® 10s è¿‡æœŸå³å¯:
```
127.0.0.1:6379> SETNX lock 1  // åŠ é”
(integer) 1
127.0.0.1:6379> EXPIRE lock 10  // è®¾ç½®è¿‡æœŸæ—¶é—´
(integer) 1
```

è¿™æ ·ä¸€æ¥ï¼Œæ— è®ºå®¢æˆ·ç«¯æ˜¯å¦å¼‚å¸¸ï¼Œè¿™ä¸ªé”ğŸ”’éƒ½å¯ä»¥åœ¨ 10s åè¢«**è‡ªåŠ¨é‡Šæ”¾**ï¼Œå…¶å®ƒå®¢æˆ·ç«¯ä¾æ—§å¯ä»¥æ‹¿åˆ°é”ã€‚

ä½†è¿™æ ·çœŸçš„æ²¡é—®é¢˜å—ï¼Ÿè¿˜æ˜¯æœ‰é—®é¢˜ï¼ï¼
ç°åœ¨çš„æ“ä½œï¼ŒåŠ é”ã€è®¾ç½®è¿‡æœŸæ—¶é—´æ˜¯2æ¡å‘½ä»¤ï¼Œæœ‰æ²¡æœ‰å¯èƒ½åªæ‰§è¡Œäº†ç¬¬ä¸€æ¡ï¼Œç¬¬äºŒæ¡å´**æ¥ä¸åŠ**æ‰§è¡Œçš„æƒ…å†µå‘ç”Ÿå‘¢ï¼Ÿä¾‹å¦‚ï¼š
1. SETNX æ‰§è¡ŒæˆåŠŸï¼Œæ‰§è¡Œ EXPIRE æ—¶ç”±äºç½‘ç»œé—®é¢˜ï¼Œæ‰§è¡Œå¤±è´¥
2. SETNX æ‰§è¡ŒæˆåŠŸï¼Œ Redis å¼‚å¸¸å®•æœºï¼ŒEXPIRE æ²¡æœºä¼šæ‰§è¡Œ
3. SETNX æ‰§è¡ŒæˆåŠŸï¼Œå®¢æˆ·ç«¯å¼‚å¸¸å´©æºƒï¼ŒEXPIRE ä¹Ÿæ²¡æœºä¼šæ‰§è¡Œ

æ€»ä¹‹ï¼Œè¿™ä¸¤æ¡å‘½ä»¤ä¸èƒ½ä¿è¯æ˜¯**åŸå­æ“ä½œ**ï¼Œå°±æœ‰æ½œåœ¨çš„é£é™©å¯¼è‡´è¿‡æœŸæ—¶é—´è®¾ç½®å¤±è´¥ï¼Œä¾æ—§å‘ç”Ÿ**æ­»é”**ğŸ”’é—®é¢˜ã€‚

æ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿ

åœ¨ Reids 2.6.12 ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æƒ³å°½åŠæ³•ï¼Œä¿è¯ `SETNX` å’Œ `EXPIRE` åŸå­æ€§æ‰§è¡Œï¼Œè¿˜è¦è€ƒè™‘å„ç§å¼‚å¸¸æƒ…å†µå¦‚ä½•å¤„ç†ã€‚

ä½†åœ¨ Redis 2.6.12 ä¹‹åï¼ŒRedis æ‰©å±•äº† SET å‘½ä»¤å‚æ•°ï¼Œç”¨ä¸‹é¢è¿™ä¸€æ¡å‘½ä»¤å°±å¯ä»¥äº†ï¼š
```
// ä¸€æ¡å‘½ä»¤ä¿è¯åŸå­æ‰§è¡Œ
127.0.0.1:6379> SET lock 1 EX 10 NX // åŠ é”
OK
```

è¿™æ ·å°±è§£å†³äº†æ­»é”ğŸ”’é—®é¢˜ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ã€‚

æˆ‘ä»¬å†æ¥åˆ†æä¸‹ï¼Œè¿™ç§æ–¹å¼æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
è¯•æƒ³è¿™æ ·ä¸€ç§åœºæ™¯:
1. å®¢æˆ·ç«¯1åŠ é”æˆåŠŸï¼Œå¼€å§‹æ“ä½œå…±äº«èµ„æº
2. å®¢æˆ·ç«¯1æ“ä½œå…±äº«èµ„æºçš„æ—¶é—´ï¼Œ**è¶…è¿‡**äº†é”çš„è¿‡æœŸæ—¶é—´ï¼Œé”è¢«**è¿‡æœŸè‡ªåŠ¨é‡Šæ”¾**
3. å®¢æˆ·ç«¯2åŠ é”æˆåŠŸï¼Œå¼€å§‹æ“ä½œå…±äº«èµ„æº
4. å®¢æˆ·ç«¯1æ“ä½œå…±äº«èµ„æºå®Œæˆï¼Œé‡Šæ”¾é”(ä½†é‡Šæ”¾çš„æ˜¯å®¢æˆ·ç«¯2çš„é”)

çœ‹åˆ°äº†å—ï¼Ÿè¿™é‡Œå­˜åœ¨ä¸¤ä¸ªä¸¥é‡çš„é—®é¢˜ï¼š
 1. **é”è¿‡æœŸ**ï¼šå®¢æˆ·ç«¯1æ“ä½œå…±äº«èµ„æºè€—æ—¶å¤ªä¹…ï¼Œå¯¼è‡´é”ğŸ”’è¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œä¹‹åè¢«å®¢æˆ·ç«¯2æŒæœ‰
 2. **é‡Šæ”¾åˆ«äººçš„é”**ï¼šå®¢æˆ·ç«¯1æ“ä½œå…±äº«èµ„æºå®Œæˆåï¼Œå´é‡Šæ”¾äº†å®¢æˆ·ç«¯2çš„é”

å¯¼è‡´è¿™ä¸¤ä¸ªé—®é¢˜çš„æ ¹æºæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ï¼š
> ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¯èƒ½æ˜¯æˆ‘ä»¬è¯„ä¼°æ“ä½œå…±äº«èµ„æºçš„æ—¶é—´ä¸å‡†ç¡®å¯¼è‡´çš„ã€‚

ä¾‹å¦‚ï¼Œæ“ä½œå…±äº«èµ„æºçš„æ—¶é—´**æœ€æ…¢**å¯èƒ½éœ€è¦ 15sï¼Œè€Œæˆ‘ä»¬å´åªè®¾ç½®äº† 10s è¿‡æœŸï¼Œé‚£è¿™å°±å­˜åœ¨é”ğŸ”’æå‰è¿‡æœŸçš„é£é™©ã€‚

è¿‡æœŸæ—¶é—´å¤ªçŸ­ï¼Œé‚£æˆ‘ä»¬å¢å¤§å†—ä½™æ—¶é—´ï¼Œå‡å¦‚è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 20sï¼Œè¿™æ ·æ€»å¯ä»¥äº†å§ï¼Ÿ

è¿™æ ·ç¡®å®å¯ä»¥**ç¼“è§£**è¿™ä¸ªé—®é¢˜ï¼Œé™ä½å‡ºé—®é¢˜çš„æ¦‚ç‡ï¼Œä½†ä¾æ—§æ— æ³•**å½»åº•è§£å†³**é—®é¢˜ã€‚ä¸ºä»€ä¹ˆï¼Ÿ

åŸå› åœ¨äºï¼Œå®¢æˆ·ç«¯åœ¨æ‹¿åˆ°é”ä¹‹åï¼Œåœ¨æ“ä½œå…±äº«èµ„æºæ—¶ï¼Œé‡åˆ°çš„åœºæ™¯å¯èƒ½æ˜¯å¾ˆå¤æ‚çš„ï¼Œä¾‹å¦‚ï¼Œç¨‹åºå†…éƒ¨å‘ç”Ÿå¼‚å¸¸ã€ç½‘ç»œè¯·æ±‚è¶…æ—¶ç­‰ç­‰ã€‚

æ—¢ç„¶æ˜¯**é¢„ä¼°**æ—¶é—´ï¼Œä¹Ÿåªèƒ½æ˜¯å¤§è‡´è®¡ç®—ï¼Œé™¤éä½ èƒ½é¢„æ–™å¹¶è¦†ç›–åˆ°æ‰€æœ‰å¯¼è‡´è€—æ—¶å˜é•¿çš„åœºæ™¯ï¼Œä½†è¿™å…¶å®æ˜¯ä¸ç°å®çš„ã€‚

æœ‰ä»€ä¹ˆæ›´å¥½çš„æ–¹æ¡ˆå—ï¼Ÿ

å…ˆåˆ«ç€æ€¥ï¼Œå…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨åé¢è¯¦ç»†æ¥è®²å¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚

æˆ‘ä»¬ç»§ç»­æ¥çœ‹ç¬¬äºŒä¸ªé—®é¢˜
> ç¬¬äºŒä¸ªé—®é¢˜åœ¨äºï¼Œä¸€ä¸ªå®¢æˆ·ç«¯é‡Šæ”¾äº†å…¶å®ƒå®¢æˆ·ç«¯æŒæœ‰çš„é”ğŸ”’

æƒ³ä¸€ä¸‹ï¼Œå¯¼è‡´è¿™ä¸ªé—®é¢˜çš„å…³é”®ç‚¹åœ¨å“ªï¼Ÿ

é‡ç‚¹åœ¨äºï¼Œæ¯ä¸ªå®¢æˆ·ç«¯åœ¨é‡Šæ”¾é”ğŸ”’æ—¶ï¼Œéƒ½æ˜¯**æ— è„‘**æ“ä½œï¼Œå¹¶æ²¡æœ‰æ£€æŸ¥è¿™æŠŠé”æ˜¯å¦è¿˜**å½’è‡ªå·±æŒæœ‰**ï¼Œæ‰€ä»¥å°±ä¼šå‘ç”Ÿé‡Šæ”¾åˆ«äººé”çš„é£é™©ï¼Œè¿™æ ·çš„è§£é”æµç¨‹ï¼Œå¾ˆä¸**ä¸¥è°¨**ï¼ï¼ï¼

å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

#### é”è¢«åˆ«äººé‡Šæ”¾æ€ä¹ˆåŠï¼Ÿ
è§£å†³åŠæ³•æ˜¯ï¼šå®¢æˆ·ç«¯åœ¨åŠ é”çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªåªæœ‰è‡ªå·±çŸ¥é“çš„**å”¯ä¸€æ ‡è¯†**è¿›å»ã€‚

ä¾‹å¦‚ï¼Œå¯ä»¥æ˜¯è‡ªå·±çš„çº¿ç¨‹ IDï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª UUIDï¼ˆéšæœºä¸”å”¯ä¸€ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ UUID ä¸¾ä¾‹ï¼š
```
// é”çš„ VALUE è®¾ç½®ä¸º UUID, è¿™é‡Œå‡è®¾ 20s æ“ä½œæ—¶é—´å®Œå…¨è¶³å¤Ÿï¼Œå…ˆä¸è€ƒè™‘é”è‡ªåŠ¨è¿‡æœŸçš„é—®é¢˜
127.0.0.1:6379> SET lock $uuid EX 20 NX
OK
```
ä¹‹åï¼Œåœ¨é‡Šæ”¾é”ğŸ”’çš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­è¿™æŠŠé”ğŸ”’æ˜¯å¦è¿˜å½’è‡ªå·±æŒæœ‰ï¼Œä¼ªä»£ç å¯ä»¥è¿™ä¹ˆå†™ï¼š
```
// åªæœ‰é”æ˜¯è‡ªå·±çš„ï¼Œæ‰é‡Šæ”¾
if redis.get("lock") == $uuid:
    redis.del("lock")
```
è¿™é‡Œé‡Šæ”¾ä½¿ç”¨çš„æ˜¯ `GET + DEL` ä¸¤æ¡å‘½ä»¤ï¼Œè¿™æ—¶ï¼Œåˆä¼šé‡åˆ°æˆ‘ä»¬å‰é¢è®²çš„åŸå­æ€§é—®é¢˜äº†ã€‚
1. å®¢æˆ·ç«¯1æ‰§è¡Œ `GET`, åˆ¤æ–­é”ğŸ”’æ˜¯è‡ªå·±çš„
2. æ­¤æ—¶é”ğŸ”’è‡ªåŠ¨è¿‡æœŸï¼Œå®¢æˆ·ç«¯2æ‰§è¡Œ `SET` å‘½ä»¤ï¼Œè·å–åˆ°é”ğŸ”’(è™½ç„¶å‘ç”Ÿçš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œä½†æˆ‘ä»¬éœ€è¦ä¸¥è°¨åœ°è€ƒè™‘é”çš„å®‰å…¨æ€§æ¨¡å‹)
3. å®¢æˆ·ç«¯1æ‰§è¡Œ `DEL`, å´é‡Šæ”¾äº†å®¢æˆ·ç«¯2çš„é”ğŸ”’

ç”±æ­¤å¯è§ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤è¿˜æ˜¯éœ€è¦åŸå­æ‰§è¡Œæ‰è¡Œï¼Œæ€æ ·åŸå­æ‰§è¡Œå‘¢ï¼ŸLuaè„šæœ¬ï¼ï¼

æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªé€»è¾‘ï¼Œå†™æˆ Lua è„šæœ¬ï¼Œè®© Redis æ¥æ‰§è¡Œã€‚

å› ä¸º Redis æ˜¯**å•çº¿ç¨‹**æ‰§è¡Œçš„ï¼Œåœ¨æ‰§è¡Œä¸€ä¸ª Lua è„šæœ¬æ—¶ï¼Œå…¶å®ƒè¯·æ±‚å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°è¿™ä¸ª Lua è„šæœ¬å¤„ç†å®Œæˆï¼Œè¿™æ ·ä¸€æ¥ï¼Œ`GET + DEL` ä¹‹é—´å°±ä¸ä¼šæ’å…¥å…¶å®ƒå‘½ä»¤äº†ã€‚

å®‰å…¨é‡Šæ”¾é”ğŸ”’çš„ Lua è„šæœ¬å¦‚ä¸‹ï¼š
```
// åˆ¤æ–­é”æ˜¯è‡ªå·±çš„ï¼Œæ‰é‡Šæ”¾
if redis.call("GET", KEYS[1]) == ARGV[1]:
then
    return redis.call("DEL", KEYS[1])
else
    return 0
end
```
å¥½äº†ï¼Œè¿™æ ·ä¸€è·¯ä¼˜åŒ–ä¸‹æ¥ï¼Œæ•´ä¸ªåŠ é”ã€è§£é”çš„æµç¨‹å°±æ›´**ä¸¥è°¨**äº†ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆæ€»ç»“ä¸€ä¸‹ï¼ŒåŸºäº Reids å®ç°çš„åˆ†å¸ƒå¼é”ğŸ”’ï¼Œä¸€ä¸ªä¸¥è°¨çš„æµç¨‹å¦‚ä¸‹ï¼š
1. åŠ é”ï¼š`SET $lock_key $unique_id EX $expire_time NX`
2. æ“ä½œå…±äº«èµ„æº
3. Luaè„šæœ¬ï¼Œå…ˆ `GET` åˆ¤æ–­é”ğŸ”’æ˜¯å¦å½’å±è‡ªå·±ï¼Œç„¶åå† `DEL` é‡Šæ”¾é”ğŸ”’
![æµç¨‹ä¼˜åŒ–å›¾](./picture/what-is-it-001-003.svg)

å¥½äº†ï¼Œæœ‰äº†è¿™ä¸ªå®Œæ•´çš„é”ğŸ”’æ¨¡å‹ï¼Œè®©æˆ‘ä»¬å›åˆ°å‰é¢æåˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚

#### é”è¿‡æœŸæ—¶é—´ä¸å¥½è¯„ä¼°æ€ä¹ˆåŠï¼Ÿ
> å‰é¢æˆ‘ä»¬æåˆ°ï¼Œé”çš„è¿‡æœŸæ—¶é—´å¦‚æœè¯„ä¼°ä¸å¥½ï¼Œè¿™ä¸ªé”ğŸ”’å°±ä¼šæœ‰**æå‰**è¿‡æœŸçš„é£é™©

å½“æ—¶ç»™å‡ºçš„å¦¥åæ–¹æ¡ˆæ˜¯ï¼Œå°½é‡**å†—ä½™**è¿‡æœŸæ—¶é—´ï¼Œé™ä½é”ğŸ”’æå‰è¿‡æœŸçš„æ¦‚ç‡ã€‚

è¿™ä¸ªæ–¹æ¡ˆå…¶å®ä¹Ÿä¸èƒ½å®Œç¾è§£å†³é—®é¢˜ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿ

æ˜¯å¦å¯ä»¥è®¾è®¡è¿™æ ·çš„æ–¹æ¡ˆï¼šåŠ é”æ—¶ï¼Œå…ˆè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œç„¶åæˆ‘ä»¬å¼€å¯ä¸€ä¸ª**å®ˆæŠ¤çº¿ç¨‹**ï¼Œå®šæ—¶å»æ£€æµ‹è¿™ä¸ªé”çš„å®æ•ˆæ—¶é—´ï¼Œå¦‚æœé”å¿«è¦è¿‡æœŸäº†ï¼Œæ“ä½œå…±äº«èµ„æºè¿˜æœªå®Œæˆï¼Œé‚£ä¹ˆå°±è‡ªåŠ¨å¯¹é”è¿›è¡Œ**ç»­æœŸ**ï¼Œé‡æ–°è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚

è¿™ç¡®å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆã€‚

å¦‚æœä½ æ˜¯ Java æŠ€æœ¯æ ˆï¼Œå¹¸è¿çš„æ˜¯ï¼Œå·²ç»æœ‰ä¸€ä¸ªåº“æŠŠè¿™äº›å·¥ä½œéƒ½å°è£…å¥½äº†ï¼š**Redisson**.

Redisson æ˜¯ä¸€ä¸ª Java è¯­è¨€å®ç°çš„ Redis SDK å®¢æˆ·ç«¯ï¼Œåœ¨ä½¿ç”¨åˆ†å¸ƒå¼é”ğŸ”’æ—¶ï¼Œå®ƒå°±é‡‡ç”¨äº†**è‡ªåŠ¨ç»­æœŸ**çš„æ–¹æ¡ˆæ¥é¿å…é”è¿‡æœŸï¼Œè¿™ä¸ªå®ˆæŠ¤çº¿ç¨‹æˆ‘ä»¬ä¸€èˆ¬ä¹ŸæŠŠå®ƒå«åš**çœ‹é—¨ç‹—ğŸ¶**çº¿ç¨‹ã€‚

![Redssonå›¾](./picture/what-is-it-001-004.svg)

é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸ª SDK è¿˜å°è£…äº†å¾ˆå¤šæ˜“ç”¨çš„åŠŸèƒ½ï¼š
- å¯é‡å…¥é”
- ä¹è§‚é”
- å…¬å¹³é”
- è¯»å†™é”
- RedLock(çº¢é”ï¼Œä¸‹é¢ä¼šè¯¦ç»†è®²)

è¿™ä¸ª SDK æä¾›çš„ API éå¸¸å‹å¥½ï¼Œå®ƒå¯ä»¥åƒæœ¬åœ°æ“ä½œæœ¬åœ°é”çš„æ–¹å¼ï¼Œæ“ä½œåˆ†å¸ƒå¼é”ğŸ”’ã€‚å¦‚æœä½ æ˜¯ JavaæŠ€æœ¯æ ˆï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
> è¿™é‡Œä¸è¯¦ç»†ä»‹ç» Redisson çš„ä½¿ç”¨ï¼Œå¯ä»¥æŸ¥çœ‹å®˜æ–¹ Github å­¦ä¹ å¦‚ä½•ä½¿ç”¨

åˆ°è¿™é‡Œæˆ‘ä»¬å†å°ç»“ä¸€ä¸‹ï¼ŒåŸºäº Redis å®ç°çš„åˆ†å¸ƒå¼é”ğŸ”’ï¼Œå‰é¢é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼š
1. æ­»é”ï¼š è®¾ç½®è¿‡æœŸæ—¶é—´
2. è¿‡æœŸæ—¶é—´ä¸å¥½è¯„ä¼°ï¼Œé”æå‰è¿‡æœŸï¼šå®ˆæŠ¤çº¿ç¨‹ï¼Œè‡ªåŠ¨ç»­æœŸ
3. é”è¢«åˆ«äººé‡Šæ”¾ï¼šé”å†™å…¥å”¯ä¸€æ ‡è¯†ï¼Œé‡Šæ”¾é”å…ˆæ£€æŸ¥æ ‡è¯†ï¼Œå†é‡Šæ”¾

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›é—®é¢˜åœºæ™¯ä¼šå±å®³ Redis é”ğŸ”’çš„å®‰å…¨æ€§å‘¢ï¼Ÿï¼Ÿ

ä¹‹å‰åˆ†æçš„åœºæ™¯éƒ½æ˜¯ï¼Œé”ğŸ”’åœ¨**å•ä¸ª** Redis å®ä¾‹ä¸­å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ° Redis çš„éƒ¨ç½²æ¶æ„ç»†èŠ‚ã€‚

è€Œæˆ‘ä»¬åœ¨ä½¿ç”¨ Redis æ—¶ï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨**ä¸»ä»é›†ç¾¤ + å“¨å…µ** çš„éƒ¨ç½²æ¨¡å¼ï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼Œå½“ä¸»åº“å¼‚å¸¸å®•æœºæ—¶ï¼Œå“¨å…µå¯ä»¥å®ç°**æ•…éšœè‡ªåŠ¨åˆ‡æ¢**ï¼ŒæŠŠä»åº“æå‡ä¸ºä¸»åº“ï¼Œç»§ç»­æä¾›æœåŠ¡ï¼Œä»¥æ­¤ä¿è¯å¯ç”¨æ€§ã€‚

é‚£å½“**ä¸»ä»å‘ç”Ÿåˆ‡æ¢æ—¶**ï¼Œè¿™ä¸ªåˆ†å¸ƒå¼é”ğŸ”’ä¾æ—§å®‰å…¨å—ï¼Ÿï¼Ÿ

è¯•æƒ³è¿™æ ·çš„åœºæ™¯
1. å®¢æˆ·ç«¯1åœ¨ä¸»åº“ä¸Šæ‰§è¡Œ `SET` å‘½ä»¤ï¼ŒåŠ é”æˆåŠŸ
2. æ­¤æ—¶ï¼Œä¸»åº“å¼‚å¸¸å®•æœºï¼Œ`SET` å‘½ä»¤è¿˜æœªåŒæ­¥åˆ°ä»åº“ä¸Š(ä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥çš„)
3. ä»åº“è¢«å“¨å…µæå‡ä¸ºæ–°çš„ä¸»åº“ï¼Œè¿™ä¸ªé”ğŸ”’åœ¨æ–°çš„ä¸»åº“ä¸Šï¼Œä¸¢å¤±äº†ï¼ï¼

![é”ä¸¢å¤±ç¤ºæ„å›¾](./picture/what-is-it-001-005.svg)

å¯è§ï¼Œå½“å¼•å…¥ Redis å¤šå‰¯æœ¬åï¼Œåˆ†å¸ƒå¼é”ğŸ”’è¿˜æ˜¯å¯èƒ½ä¼šæ”¶åˆ°å½±å“ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿï¼Ÿ

ä¸ºæ­¤ï¼ŒRedis çš„ä½œè€…æå‡ºä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„ **Redlock**(çº¢é”ğŸ”’)ã€‚

é‚£å®ƒçœŸçš„å¯ä»¥è§£å†³ä¸Šé¢è¿™ä¸ªé—®é¢˜å—ï¼Ÿï¼Ÿ

#### Redlock çœŸçš„å®‰å…¨å—
> å¥½äº†ï¼Œå‰é¢åšäº†è¿™ä¹ˆå¤šé“ºå«ï¼Œç°åœ¨ç»ˆäºåˆ°äº†çœŸæ­£çš„ç¡¬æ ¸çŸ¥è¯†äº†ï¼Œä¸‹é¢æˆ‘ä»¬ä¸ä»…ä»…åªæ˜¯è®² Redlock ç›¸å…³çš„åŸç†ï¼Œè¿˜ä¼šå¼•å‡ºè®¸å¤šå’Œ**åˆ†å¸ƒå¼ç³»ç»Ÿ**ç›¸å…³çš„é—®é¢˜ã€‚ç³»å¥½å®‰å…¨å¸¦ï¼Œæˆ‘ä»¬å‡ºå‘...

ç°åœ¨æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œ Redis ä½œè€…æå‡ºçš„ Redlock æ–¹æ¡ˆï¼Œæ˜¯å¦‚ä½•è§£å†³ä¸»ä»åˆ‡æ¢åï¼Œé”ğŸ”’å¤±æ•ˆé—®é¢˜çš„ã€‚

Redlock çš„æ–¹æ¡ˆåŸºäºä¸¤ä¸ªå‰æï¼šâ€˜
1. ä¸å†éœ€è¦éƒ¨ç½²ä»åº“å’Œå“¨å…µå®ä¾‹ï¼Œåªéƒ¨ç½²ä¸»åº“
2. ä½†ä¸»åº“è¦éƒ¨ç½²å¤šä¸ªï¼Œå®˜æ–¹æ¨èè‡³å°‘ 5 ä¸ªå®ä¾‹

ä¹Ÿå°±æ˜¯è¯´ï¼Œæƒ³ä½¿ç”¨ Redlockï¼Œ ä½ è‡³å°‘è¦éƒ¨ç½² 5 ä¸ª Redis å®ä¾‹ï¼Œè€Œä¸”å®ƒä»¬éƒ½æ˜¯ä»åº“ï¼Œå®ƒä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸ªå­¤ç«‹çš„å®ä¾‹ã€‚**ä¸æ˜¯éƒ¨ç½² Redis Clusterï¼Œå°±æ˜¯éƒ¨ç½² 5 ä¸ªç®€å•çš„ Redis å®ä¾‹**ã€‚

![é”ä¸¢å¤±ç¤ºæ„å›¾](./picture/what-is-it-001-006.svg)

Redlock çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼Œä¸€å…±åˆ†ä¸º 5 æ­¥ï¼š
1. å®¢æˆ·ç«¯å…ˆè·å–**å½“å‰æ—¶é—´æˆ³T1**
2. å®¢æˆ·ç«¯ä¾æ¬¡å‘è¿™äº”ä¸ª Redis å®ä¾‹å‘èµ·åŠ é”è¯·æ±‚(ç”¨å‰é¢è®²çš„ `SET` è¯·æ±‚)ï¼Œä¸”æ¯ä¸ªè¯·æ±‚ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´(æ¯«ç§’çº§ï¼Œè¦è¿œå°äºé”çš„æœ‰æ•ˆæ—¶é—´)ï¼Œå¦‚æœæŸä¸€ä¸ªå®ä¾‹åŠ é”é”å¤±è´¥(åŒ…æ‹¬ç½‘ç»œè¶…æ—¶ã€é”ğŸ”’è¢«å…¶å®ƒäººæŒæœ‰ç­‰å„ç§æƒ…å†µ)ï¼Œå°±ç«‹å³å‘ä¸‹ä¸€ä¸ª Redis å®ä¾‹ç”³è¯·åŠ é”ğŸ”’ã€‚
3. å¦‚æœå®¢æˆ·ç«¯ä» >=3 ä¸ªï¼ˆå¤šæ•°ï¼‰ä»¥ä¸Š Redis å®ä¾‹åŠ é”æˆåŠŸï¼Œåˆ™å†æ¬¡è·å–**å½“å‰æ—¶é—´æˆ³T2**ï¼Œå¦‚æœ T2 - T1 < é”çš„è¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶ï¼Œè®¤ä¸ºå®¢æˆ·ç«¯åŠ é”æˆåŠŸï¼Œå¦åˆ™è®¤ä¸ºåŠ é”å¤±è´¥ã€‚
4. åŠ é”æˆåŠŸï¼Œå»æ“ä½œå…±äº«èµ„æº
5. åŠ é”å¤±è´¥ï¼Œå‘**å…¨éƒ¨èŠ‚ç‚¹**å‘èµ·é‡Šæ”¾é”ğŸ”’è¯·æ±‚(ç”¨å‰é¢è®²çš„ Lua è„šæœ¬é‡Šæ”¾)

æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ï¼Œæœ‰ 4 ä¸ªé‡ç‚¹ï¼š
1. å®¢æˆ·ç«¯å¿…é¡»åœ¨å¤šä¸ª Redis å®ä¾‹ä¸ŠåŠ é”
2. å¿…é¡»ä¿è¯å¤§å¤šæ•°èŠ‚ç‚¹åŠ é”æˆåŠŸ
3. å¤§å¤šæ•°èŠ‚ç‚¹åŠ é”çš„æ€»è€—æ—¶ï¼Œè¦å°äºé”ğŸ”’è®¾ç½®çš„è¿‡æœŸæ—¶é—´
4. é‡Šæ”¾é”ğŸ”’ï¼Œè¦å‘å…¨éƒ¨èŠ‚ç‚¹å‘èµ·é‡Šæ”¾é”ğŸ”’è¯·æ±‚

> ä¸Šè¿°æµç¨‹ç¬¬ä¸€æ¬¡çœ‹å¯èƒ½ä¸å¤ªç†è§£ï¼Œå»ºè®®å¯ä»¥å¤šçœ‹ä¸¤éï¼Œè¿›ä¸€æ­¥åŠ æ·±ç†è§£ï¼Œæˆ‘ä»¬ä¸‹é¢æ ¹æ®è¿™ä¸ªæµç¨‹ï¼Œè¿›ä¸€æ­¥å‰–æå„ç§å¯¼è‡´é”ğŸ”’å¤±æ•ˆçš„é—®é¢˜å‡è®¾ã€‚

##### ä¸ºä»€ä¹ˆè¦åœ¨å¤šä¸ªå®ä¾‹ä¸ŠåŠ é”ï¼Ÿ
æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†**å®¹é”™**ï¼Œéƒ¨åˆ†å®ä¾‹å¼‚å¸¸å®•æœºï¼Œå‰©ä½™çš„å®ä¾‹åŠ é”ğŸ”’æˆåŠŸï¼Œæ•´ä¸ªé”ğŸ”’æœåŠ¡ä¾æ—§å¯ç”¨ã€‚

##### ä¸ºä»€ä¹ˆå¤§å¤šæ•°å®ä¾‹åŠ é”æˆåŠŸï¼Œæ‰ç®—ç”³è¯·é”æˆåŠŸï¼Ÿ
å¤šä¸ª Reids å®ä¾‹ä¸€èµ·ä½¿ç”¨ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç»„æˆäº†ä¸€ä¸ª**åˆ†å¸ƒå¼ç³»ç»Ÿ**ã€‚

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ€»ä¼šå‡ºç°**å¼‚å¸¸èŠ‚ç‚¹**ï¼Œæ‰€ä»¥ï¼Œåœ¨è°ˆè®ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„é—®é¢˜æ—¶ï¼Œéœ€è¦è€ƒè™‘å¼‚å¸¸èŠ‚ç‚¹è¾¾åˆ°å¤šå°‘ä¸ªï¼Œä¹Ÿä¾æ—§ä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„**æ­£ç¡®æ€§**ã€‚

è¿™æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„**å®¹é”™**é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜çš„ç»“è®ºæ˜¯ï¼šå¦‚æœåªå­˜åœ¨**æ•…éšœèŠ‚ç‚¹**ï¼Œåªè¦å¤§å¤šæ•°èŠ‚ç‚¹æ­£å¸¸ï¼Œé‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿä¾æ—§æ˜¯å¯ä»¥æä¾›æ­£ç¡®æœåŠ¡çš„ã€‚

##### ä¸ºä»€ä¹ˆå¤§å¤šæ•°å®ä¾‹åŠ é”æˆåŠŸä¹‹åï¼Œè¿˜è¦è®¡ç®—åŠ é”çš„ç´¯è®¡è€—æ—¶ï¼Ÿ
å› ä¸ºæ“ä½œçš„æ˜¯å¤šä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è€—æ—¶è‚¯å®šä¼šæ¯”æ“ä½œå•ä¸ªå®ä¾‹è€—æ—¶æ›´ä¹…ï¼Œè€Œä¸”ï¼Œå› ä¸ºæ˜¯ç½‘ç»œè¯·æ±‚ï¼Œç½‘ç»œçš„æƒ…å†µæ˜¯å¤æ‚çš„ï¼Œæœ‰å¯èƒ½å­˜åœ¨**å»¶è¿Ÿã€ä¸¢åŒ…ã€è¶…æ—¶**ç­‰æƒ…å†µå‘ç”Ÿï¼Œç½‘ç»œè¯·æ±‚è¶Šå¤šï¼Œå¼‚å¸¸å‘ç”Ÿçš„æ¦‚ç‡ä¹Ÿè¶Šå¤§ã€‚

æ‰€ä»¥ï¼Œå³ä½¿å¤§å¤šæ•°èŠ‚ç‚¹åŠ é”æˆåŠŸäº†ï¼Œä½†å¦‚æœåŠ é”ğŸ”’çš„è€—æ—¶å·²ç»**è¶…è¿‡**äº†é”ğŸ”’çš„è¶…æ—¶æ—¶é—´ï¼Œé‚£æ­¤æ—¶æœ‰äº›å®ä¾‹ä¸Šçš„é”ğŸ”’å¯èƒ½å·²ç»å¤±æ•ˆäº†ï¼Œè¿™ä¸ªé”ä¹…æ²¡æœ‰æ„ä¹‰äº†ã€‚

##### ä¸ºä»€ä¹ˆé‡Šæ”¾é”ï¼Œè¦æ“ä½œæ‰€æœ‰èŠ‚ç‚¹ï¼Ÿ
åœ¨æŸä¸€ä¸ª Redis èŠ‚ç‚¹åŠ é”æ—¶ï¼Œå¯èƒ½å› ä¸º**ç½‘ç»œåŸå› **å¯¼è‡´åŠ é”å¤±è´¥ã€‚

ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯åœ¨ä¸€ä¸ª Reids èŠ‚ç‚¹èŠ‚ç‚¹ä¸ŠåŠ é”æˆåŠŸï¼Œä½†åœ¨è¯»å–å“åº”ç»“æœæ—¶ï¼Œç½‘ç»œé—®é¢˜å¯¼è‡´**è¯»å–å¤±è´¥**ï¼Œé‚£è¿™æŠŠé”ğŸ”’å…¶å®å·²ç»åœ¨ Redis ä¸ŠåŠ é”æˆåŠŸäº†ã€‚

æ‰€ä»¥ï¼Œé‡Šæ”¾é”ğŸ”’æ—¶ï¼Œä¸é¡¾ä¹‹å‰æœ‰æ²¡æœ‰åŠ é”ğŸ”’æˆåŠŸï¼Œéœ€è¦é‡Šæ”¾**æ‰€æœ‰èŠ‚ç‚¹**çš„é”ï¼Œä»¥ä¿è¯æ¸…ç†èŠ‚ç‚¹ä¸Š**æ®‹ç•™**çš„é”ã€‚

ä»¥ä¸Šå°±æ˜¯ redlock çš„æ•´ä¸ªæµç¨‹å’Œç›¸å…³é—®é¢˜äº†ï¼Œçœ‹ä¸Šå» redlock ç¡®å®è§£å†³äº† Redis èŠ‚ç‚¹å¼‚å¸¸å®•æœºå‘ç”Ÿåˆ‡æ¢æ—¶é”å¤±æ•ˆçš„é—®é¢˜ï¼Œä¿è¯äº†é”ğŸ”’çš„**å®‰å…¨æ€§**ã€‚

ä½†äº‹å®çœŸçš„å¦‚æ­¤å—ï¼Ÿï¼Ÿ

#### Redlock çš„äº‰è®º

Redis ä½œè€…æŠŠè¿™ä¸ªæ–¹æ¡ˆä¸€ç»æå‡ºï¼Œå°±é©¬ä¸Šæ”¶åˆ°ä¸šç•Œç©ç›®çš„åˆ†å¸ƒå¼ä¸“å®¶çš„**è´¨ç–‘**ï¼

è¿™ä¸ªäººå°±æ˜¯ Martinï¼Œæ˜¯çš„ï¼Œä»–å°±æ˜¯è‘—ååˆ†å¸ƒå¼ä¹¦ç±[æ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡(DDIA)](http:www.baidu.com)çš„ä½œè€…ï¼Œä»–ç»å¸¸åœ¨å¤§ä¼šåšæ¼”è®²ï¼Œå†™åšå®¢ï¼Œå†™ä¹¦ï¼Œä¹Ÿæ˜¯å¼€æºè´¡çŒ®è€…ã€‚


Martin é©¬ä¸Šå†™äº†ç¯‡æ–‡ç« ï¼Œè´¨ç–‘è¿™ä¸ª Redlock çš„ç®—æ³•æ¨¡å‹æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¹¶å¯¹åˆ†å¸ƒå¼é”çš„è®¾è®¡ï¼Œæå‡ºäº†è‡ªå·±çš„çœ‹æ³•ã€‚

ä¹‹åï¼ŒRedis çš„ä½œè€… Antirez é¢å¯¹è´¨ç–‘ï¼Œä¸ç”˜ç¤ºå¼±ï¼Œä¹Ÿå†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œåé©³äº†å¯¹æ–¹çš„è§‚ç‚¹ï¼Œå¹¶è¯¦ç»†å‰–æäº† Redlock ç®—æ³•æ¨¡å‹çš„æ›´å¤šè®¾è®¡ç»†èŠ‚ã€‚

**äºŒäººæ€è·¯æ¸…æ™°, è®ºæ®å……åˆ†, è¿™æ˜¯ä¸€åœºé«˜æ‰‹è¿‡æ‹›ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸéå¸¸å¥½çš„ä¸€æ¬¡æ€æƒ³ç¢°æ’ï¼åŒæ–¹éƒ½æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸçš„ä¸“å®¶ï¼Œå´å¯¹åŒä¸€ä¸ªé—®é¢˜æå‡ºå¾ˆå¤šç›¸åçš„è®ºæ–­ï¼Œç©¶ç«Ÿæ˜¯æ€ä¹ˆå›äº‹å‘¢**ï¼Ÿ

> åé¢çš„é—®é¢˜ä¼šæ¶‰åŠåˆ°å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³çš„é—®é¢˜ï¼Œå¦‚æœæœ‰ä¸æ‡‚çš„æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒä¸Šé¢æåˆ°çš„**DDIA**è¿™æœ¬ä¹¦ï¼Œä¸‹é¢Martinæå‡ºçš„è®ºæ®å¤§éƒ½èƒ½ä»è¿™æœ¬ä¹¦é‡Œæ‰¾åˆ°ç—•è¿¹ã€‚åŒæ—¶è¿™é‡Œä¹Ÿå»ºè®®å¤§å®¶æ”¾æ…¢é˜…è¯»é€Ÿåº¦ã€‚

##### Martin çš„è´¨ç–‘
åœ¨ä»–çš„æ–‡ç« ä¸­ï¼Œä¸»è¦é˜è¿°äº† 4 ä¸ªè®ºç‚¹ï¼š
###### åˆ†å¸ƒå¼é”çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ
ä»–è®¤ä¸ºæœ‰ä¸¤ä¸ªç›®çš„ã€‚

**ç¬¬ä¸€ä¸ªæ˜¯æ•ˆç‡**
ä½¿ç”¨åˆ†å¸ƒå¼é”ğŸ”’çš„äº’æ–¥èƒ½åŠ›ï¼Œæ˜¯é¿å…ä¸å¿…è¦åœ°åšåŒæ ·çš„ä¸¤æ¬¡å·¥ä½œ(ä¾‹å¦‚ä¸€äº›æ˜‚è´µçš„è®¡ç®—ä»»åŠ¡)ã€‚å¦‚æœé”å¤±æ•ˆï¼Œå¹¶ä¸ä¼šå¸¦æ¥**æ¶æ€§**çš„åæœï¼Œæ¯”å¦‚å‘äº† 2 æ¬¡é‚®ä»¶ï¼Œæ— ä¼¤å¤§é›…ã€‚

**ç¬¬äºŒä¸ªæ˜¯æ­£ç¡®æ€§**
ä½¿ç”¨é”ğŸ”’æ¥é˜²æ­¢å¹¶å‘è¿›ç¨‹ç›¸äº’å¹²æ‰°ã€‚å¦‚æœé”ğŸ”’å¤±æ•ˆï¼Œä¼šé€ æˆå¤šä¸ªè¿›ç¨‹åŒæ—¶æ“ä½œåŒä¸€æ¡æ•°æ®ï¼Œäº§ç”Ÿçš„åæœæ˜¯**æ•°æ®ä¸¥é‡é”™è¯¯ã€æ•°æ®æ°¸ä¹…ä¸ä¸€è‡´ã€æ•°æ®ä¸¢å¤±**ç­‰æ¶æ€§é—®é¢˜ï¼Œå°±åƒç»™æ‚£è€…æœç”¨é‡å¤è®¡é‡çš„è¯ç‰©ä¸€æ ·ï¼Œåæœä¸¥é‡ã€‚

ä»–è®¤ä¸ºï¼Œå¦‚æœæ˜¯ä¸ºäº†**å‰è€…-æ•ˆç‡**ï¼Œé‚£ä¹ˆä½¿ç”¨å•æœºç‰ˆ Redis å°±å¯ä»¥äº†ï¼Œå³ä½¿å¶å°”å‘ç”Ÿé”ğŸ”’å¤±æ•ˆ(å®•æœºã€ä¸»ä»åˆ‡æ¢)ï¼Œéƒ½ä¸ä¼šäº§ç”Ÿä¸¥é‡åæœã€‚è€Œä½¿ç”¨ Redlock å¤ªé‡äº†ï¼Œæ²¡å¿…è¦ã€‚

å¦‚æœæ˜¯ä¸ºäº†**åè€…-æ­£ç¡®æ€§**ï¼ŒMartin ä»»åŠ¡ Redlock æ ¹æœ¬è¾¾ä¸åˆ°å®‰å…¨æ€§çš„è¦æ±‚ï¼Œä¹Ÿä¾æ—§å­˜åœ¨é”å¤±æ•ˆçš„é—®é¢˜ï¼ï¼


###### é”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¼šé‡åˆ°çš„é—®é¢˜
Martin è¡¨ç¤ºï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ›´åƒä¸€ä¸ªå¤æ‚çš„**é‡å…½**(), å­˜åœ¨ç€ä½ æƒ³ä¸åˆ°çš„å„ç§å¼‚å¸¸æƒ…å†µã€‚

è¿™äº›å¼‚å¸¸åœºæ™¯ä¸»è¦åŒ…æ‹¬ä¸‰å¤§å—ã€‚è¿™ä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¼šé‡åˆ°çš„ä¸‰åº§å¤§å±±ï¼š**NPC**
- N: Network Delay(ç½‘ç»œå»¶è¿Ÿ)
- P: Process Pause(è¿›ç¨‹æš‚åœ)
- C: Clock Drift(æ—¶é’Ÿâ°æ¼‚ç§»)

Martin ç”¨ä¸€ä¸ªè¿›ç¨‹æš‚åœ(GC)çš„ä¾‹å­, æŒ‡å‡ºäº† redlock çš„å®‰å…¨æ€§é—®é¢˜ï¼š
1. å®¢æˆ·ç«¯1è¯·æ±‚é”å®šèŠ‚ç‚¹ Aã€Bã€Cã€Dã€E
2. å®¢æˆ·ç«¯1æ‹¿åˆ°é”ğŸ”’åï¼Œè¿›å…¥ GC(æ—¶é—´æ¯”è¾ƒä¹…)
3. æ‰€æœ‰ Redis èŠ‚ç‚¹ä¸Šçš„é”éƒ½è¿‡æœŸäº†
4. å®¢æˆ·ç«¯2è·å–åˆ° Aã€Bã€Cã€Dã€E ä¸Šçš„é”ğŸ”’
5. å®¢æˆ·ç«¯1 GC ç»“æŸï¼Œä»»åŠ¡æˆåŠŸè·å–åˆ°é”ğŸ”’
6. å®¢æˆ·ç«¯2ä¹Ÿè®¤ä¸ºè·å–åˆ°äº†é”ğŸ”’ï¼Œå‘ç”Ÿé”**å†²çª**

![GCå¯¼è‡´é”å†²çªç¤ºæ„å›¾](./picture/what-is-it-001-007.svg)

Martin è®¤ä¸ºï¼ŒGC å¯èƒ½å‘ç”Ÿåœ¨ç¨‹åºçš„ä»»æ„æ—¶åˆ»ï¼Œè€Œä¸”æ‰§è¡Œå®ç°æ˜¯ä¸å¯æ§çš„ã€‚
> å½“ç„¶ï¼Œå³ä½¿æ˜¯æ²¡æœ‰ä½¿ç”¨ GC çš„ç¼–ç¨‹è¯­è¨€ï¼Œåœ¨å‘ç”Ÿç½‘ç»œå»¶è¿Ÿã€æ—¶é’Ÿæ¼‚ç§»çš„æ—¶å€™ï¼Œä¹Ÿéƒ½æœ‰å¯èƒ½å¯¼è‡´ redlock å‡ºç°é—®é¢˜ï¼Œè¿™é‡Œ Martin åªæ˜¯æ‹¿ GC ä¸¾ä¾‹ã€‚

###### å‡è®¾æ—¶é’Ÿè®¾ç½®æ˜¯ä¸åˆç†çš„
åˆæˆ–è€…ï¼Œå½“å¤šä¸ª Redis èŠ‚ç‚¹**æ—¶é’Ÿ**å‘ç”Ÿé—®é¢˜æ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´ redlock é”ğŸ”’å¤±æ•ˆã€‚
1. å®¢æˆ·ç«¯1è·å–èŠ‚ç‚¹ Aã€Bã€Cä¸Šçš„é”ï¼Œä½†ç”±äºç½‘ç»œé—®é¢˜ï¼Œæ— æ³•è®¿é—® D å’Œ E
2. èŠ‚ç‚¹ C ä¸Šçš„æ—¶é’Ÿ **å‘å‰è·³è·ƒ**ï¼Œå¯¼è‡´é”è¿‡æœŸ
3. å®¢æˆ·ç«¯2è·å–èŠ‚ç‚¹ Cã€Dã€E ä¸Šçš„é”ğŸ”’ï¼Œ ç”±äºç½‘ç»œé—®é¢˜ï¼Œæ— æ³•è®¿é—® A å’Œ B
4. å®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2éƒ½ç›¸ä¿¡å®ƒä»¬æŒæœ‰äº†é”ğŸ”’ï¼Œå¯¼è‡´é”å†²çªã€‚

Martin è§‰å¾—ï¼Œredlock å¿…é¡»**å¼ºä¾èµ–**å¤šä¸ªèŠ‚ç‚¹çš„æ—¶é’Ÿæ˜¯ä¿æŒåŒæ­¥çš„ï¼Œä¸€æ—¦æœ‰èŠ‚ç‚¹æ—¶é’Ÿå‘ç”Ÿé”™è¯¯ï¼Œé‚£è¿™ä¸ªç®—æ³•æ¨¡å‹å°±å¤±æ•ˆäº†ã€‚
> å³ä½¿ä¸æ˜¯æ—¶é’Ÿè·³è·ƒï¼Œè€Œæ˜¯ **å´©æºƒåç«‹å³é‡å¯**ï¼Œä¹Ÿä¼šå‘ç”Ÿç±»ä¼¼çš„é—®é¢˜ã€‚

Martin ç»§ç»­é˜è¿°ï¼Œæœºå™¨çš„æ—¶é’Ÿå‘ç”Ÿé”™è¯¯ï¼Œæ˜¯å¾ˆæœ‰å¯èƒ½å‘ç”Ÿçš„ï¼š
1. ç³»ç»Ÿç®¡ç†å‘˜**æ‰‹åŠ¨ä¿®æ”¹**äº†æœºå™¨æ—¶é’Ÿ
2. æœºå™¨æ—¶é’Ÿåœ¨åŒæ­¥ NTP æ—¶é—´æ—¶ï¼Œå‘ç”Ÿäº†å¤§çš„**è·³è·ƒ**

æ€»ä¹‹ï¼Œmartin è®¤ä¸ºï¼Œredlock çš„ç®—æ³•æ˜¯å»ºç«‹åœ¨**åŒæ­¥æ¨¡å‹**åŸºç¡€ä¸Šçš„ï¼Œæœ‰å¤§é‡èµ„æ–™ç ”ç©¶è¡¨æ˜ï¼ŒåŒæ­¥æ¨¡å‹çš„å‡è®¾ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ—¶æœ‰é—®é¢˜çš„ã€‚

åœ¨æ··ä¹±çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä½ ä¸èƒ½å‡è®¾ç³»ç»Ÿæ—¶é’Ÿå°±æ˜¯å¯¹çš„ï¼Œæ‰€ä»¥ï¼Œä½ å¿…é¡»éå¸¸å°å¿ƒä½ çš„å‡è®¾ã€‚

###### æå‡º fecing token æ–¹æ¡ˆï¼Œä¿è¯æ­£ç¡®æ€§
åªæå‡ºé—®é¢˜ï¼Œä¸æå‡ºè§£å†³æ–¹æ¡ˆçš„éƒ½æ˜¯è€æµæ°“ğŸ˜„ï¼ŒMartin æå‡ºä¸€ç§è¢«å«åš fecing token çš„æ–¹æ¡ˆï¼Œä¿è¯åˆ†å¸ƒå¼é”çš„æ­£ç¡®æ€§ã€‚

è¿™ä¸ªæ¨¡å‹æµç¨‹å¦‚ä¸‹ï¼š
1. å®¢æˆ·ç«¯åœ¨è·å–é”ğŸ”’æ—¶ï¼Œé”æœåŠ¡å¯ä»¥æä¾›ä¸€ä¸ª**é€’å¢**çš„token
2. å®¢æˆ·ç«¯æ‹¿ç€è¿™ä¸ªtokenå»æ“ä½œå…±äº«èµ„æº
3. å…±äº«èµ„æºå¯ä»¥æ ¹æ® token å»æ‹’ç»**åæ¥è€…**çš„è¯·æ±‚

![fecing token ç¤ºæ„å›¾](./picture/what-is-it-001-008.svg)

è¿™æ ·ä»¥æ¥ï¼Œæ— è®º NPC é‚£ç§æƒ…å†µå‘ç”Ÿï¼Œéƒ½å¯ä»¥ä¿è¯åˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§ï¼Œå› ä¸ºå®ƒæ˜¯å»ºç«‹åœ¨**å¼‚æ­¥æ¨¡å‹**çš„åŸºç¡€ä¸Šçš„ã€‚

è€Œ redlock æ— æ³•æä¾›ç±»ä¼¼ fecing token æ–¹æ¡ˆï¼Œæ‰€ä»¥å®ƒæ— æ³•ä¿è¯å®‰å…¨æ€§ã€‚

ä»–è¿˜è¡¨ç¤ºï¼Œä¸€ä¸ªå¥½çš„åˆ†å¸ƒå¼é”ğŸ”’ï¼Œæ— è®º NPC æ€ä¹ˆå‘ç”Ÿï¼Œå¯ä»¥ä¸åœ¨è§„å®šæ—¶é—´å†…ç»™å‡ºç»“æœï¼Œä½†å¹¶ä¸ä¼šç»™å‡ºä¸€ä¸ªé”™è¯¯çš„ç»“æœã€‚ä¹Ÿå°±æ˜¯åªä¼šå½±å“åˆ°é”çš„**æ€§èƒ½**ï¼Œè€Œä¸ä¼šå½±å“å®ƒçš„**æ­£ç¡®æ€§**ã€‚

###### Martin çš„ç»“è®º

1. **redlock ä¸ä¼¦ä¸ç±»**ï¼šå®ƒå¯¹äºæ•ˆç‡è€Œè®²ï¼Œredlock æ¯”è¾ƒé‡ï¼Œæ²¡å¿…è¦è¿™ä¹ˆåšï¼Œè€Œå¯¹äºæ­£ç¡®æ€§æ¥è¯´ï¼Œredlockæ˜¯ä¸å¤Ÿå®‰å…¨çš„ã€‚
2. **æ—¶é’Ÿå‡è®¾ä¸åˆç†**ï¼šè¯¥ç®—æ³•å¯¹ç³»ç»Ÿæ—¶é’Ÿåšå‡ºäº†å±é™©çš„å‡è®¾(å‡è®¾å¤šä¸ªèŠ‚ç‚¹çš„æ—¶é’Ÿéƒ½æ˜¯ä¸€è‡´çš„)ï¼Œå¦‚æœä¸æ»¡è¶³è¿™äº›å‡è®¾ï¼Œé”ğŸ”’å°±ä¼šå¤±æ•ˆã€‚
3. **æ— æ³•ä¿è¯æ­£ç¡®æ€§**ï¼šredlock ä¸æä¾›ç±»ä¼¼ fecing token çš„æ–¹æ¡ˆï¼Œæ‰€ä»¥è§£å†³ä¸äº†æ­£ç¡®æ€§çš„é—®é¢˜ï¼Œä¸ºäº†æ­£ç¡®æ€§ï¼Œè¯·ä½¿ç”¨æœ‰**å…±è¯†ç³»ç»Ÿ**çš„æ–¹æ¡ˆï¼Œå¦‚ Zookeeperã€‚

å¥½äº†ï¼Œä»¥ä¸Šå°±æ˜¯ Martin åå¯¹ä½¿ç”¨ redlock çš„è§‚ç‚¹ï¼Œçœ‹èµ·æ¥æœ‰ç†æœ‰æ®ã€‚

##### Antirez çš„åé©³
åœ¨ Redis ä½œè€…çš„æ–‡ç« ä¸­ï¼Œé‡ç‚¹æœ‰ 3 ä¸ªï¼š
1. è§£é‡Šæ—¶é’Ÿé—®é¢˜
2. è§£é‡Šç½‘ç»œå»¶è¿Ÿã€GCé—®é¢˜
3. è´¨ç–‘ fencing token æœºåˆ¶

###### è§£é‡Šæ—¶é’Ÿé—®é¢˜
é¦–å…ˆï¼ŒRedis çš„ä½œè€…ä¸€çœ¼å°±çœ‹ç©¿äº†å¯¹æ–¹æå‡ºçš„æœ€æ ¸å¿ƒçš„é—®é¢˜ï¼š**æ—¶é’Ÿé—®é¢˜**ã€‚

Antirez è¡¨ç¤ºï¼Œredlock å¹¶ä¸éœ€è¦å®Œå…¨ä¸€è‡´çš„æ—¶é’Ÿï¼Œåªéœ€è¦å¤§ä½“ä¸€è‡´å°±å¯ä»¥äº†ï¼Œå…è®¸æœ‰**è¯¯å·®**ã€‚

ä¾‹å¦‚è¦è®¡æ—¶âŒ›ï¸ 5sï¼Œä½†å®é™…å¯èƒ½è®°äº† 4.5sï¼Œåé¢åˆè®°äº† 5.5sï¼Œæœ‰ä¸€å®šè¯¯å·®ï¼Œä½†åªè¦ä¸è¶…è¿‡**è¯¯å·®èŒƒå›´**é”ğŸ”’å¤±æ•ˆæ—¶é—´å³å¯ï¼Œè¿™ç§å¯¹äºæ—¶é’Ÿç²¾åº¦çš„è¦æ±‚å¹¶ä¸æ˜¯å¾ˆé«˜ï¼Œè€Œä¸”è¿™ä¹Ÿç¬¦åˆç°å®ç¯å¢ƒã€‚
> æ¯”å¦‚è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´æ˜¯ 10sï¼Œåœ¨è¿™ 10s å†…å‘ç”Ÿæ—¶é’Ÿè·³è·ƒéƒ½æ˜¯ä¸å½±å“çš„ï¼Œåé¢å¯ä»¥è°ƒæ•´è¿‡æ¥ï¼Œä½†å¦‚æœè¯¯å·®è¶…è¿‡äº†é”çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ™ä¼šå¯¼è‡´ğŸ”’**æå‰è¿‡æœŸ**æˆ–è€…**å»¶è¿Ÿè¿‡æœŸ**ï¼Œä¼šäº§ç”Ÿä¸Šé¢ Martin æåˆ°çš„æ­£ç¡®æ€§é—®é¢˜ã€‚

å¯¹äº Martin æåˆ°çš„**æ—¶é’Ÿä¿®æ”¹**é—®é¢˜ï¼ŒAntirez åé©³é“ï¼š
1. **æ‰‹åŠ¨ä¿®æ”¹æ—¶é’Ÿ**ï¼š ä¸è¦è¿™ä¹ˆåšå°±å¥½äº†ï¼Œå¦åˆ™ä½ ç›´æ¥ä¿®æ”¹ Raft æ—¥å¿—ï¼Œé‚£ Raft ä¹Ÿä¼šæ— æ³•å·¥ä½œ...
2. **æ—¶é’Ÿè·³è·ƒ**ï¼šé€šè¿‡**æ°å½“çš„è¿ç»´**ï¼Œä¿è¯æœºå™¨æ—¶é’Ÿä¸ä¼šå¤§å¹…åº¦è·³è·ƒ(ä¿®æ”¹çŸ³è‹±é’Ÿéœ‡è¡é¢‘ç‡ï¼Œæ¯æ¬¡é€šè¿‡å¾®å°çš„è°ƒæ•´æ¥å®Œæˆ)ï¼Œå®é™…ä¸Šè¿™æ˜¯å¯ä»¥åšåˆ°çš„ã€‚
> ä¸ºä»€ä¹ˆ Antirez ä¼˜å…ˆè§£é‡Šæ—¶é’Ÿé—®é¢˜ï¼Ÿå› ä¸ºåœ¨åé¢çš„åé©³è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä»¥æ¥è¿™ä¸ªåŸºç¡€åšè¿›ä¸€æ­¥è§£é‡Šã€‚

###### è§£é‡Šç½‘ç»œå»¶è¿Ÿã€GCé—®é¢˜


###### Antirez çš„ç»“è®º

###### æœ€åè´¨ç–‘ fencing token æœºåˆ¶

### åŸºäºzookeeperçš„é”æ˜¯å®‰å…¨çš„å—ï¼Ÿ

### æˆ‘å¯¹åˆ†å¸ƒå¼é”çš„ç†è§£

### å‚è€ƒèµ„æ–™
1. http://zhangtielei.com/posts/blog-redlock-reasoning.html
2. https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html
3. https://news.ycombinator.com/item?id=11065933